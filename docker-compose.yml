
version: "3.8"

services:

  # ----------------------------------------
  # üîê Reverse Proxy: nginx + Let's Encrypt
  # ----------------------------------------
  proxy:
    image: nginxproxy/nginx-proxy
    container_name: reverse-proxy
    labels:
      - com.github.nginx-proxy.nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./data/proxy/certs:/etc/nginx/certs:ro
      - ./data/proxy/vhost.d:/etc/nginx/vhost.d
      - ./data/proxy/html:/usr/share/nginx/html
    networks:
      - default   # Ensure Nginx is on the same network as n8n
      - internal

  # ---------------------------

  acme:
    image: nginxproxy/acme-companion
    restart: unless-stopped
    depends_on:
      - proxy
    environment:
      - DEFAULT_EMAIL=abbasibros2014@gmail.com
      - NGINX_PROXY_CONTAINER=reverse-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./data/proxy/certs:/etc/nginx/certs
      - ./data/proxy/vhost.d:/etc/nginx/vhost.d
      - ./data/proxy/html:/usr/share/nginx/html
      - ./data/acme:/etc/acme.sh  # <-- Add this line for SSL cert persistence, otherwise it will regenerate cert with each restart.





  # ------------------------------
  # üöÄ n8n (workflow automation)
  # ------------------------------

  n8n:
    image: n8nio/n8n:latest
    # container_name: n8n
    restart: unless-stopped
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=${DOMAIN}
      - N8N_PORT=${N8N_PORT}
      - N8N_PROTOCOL=${PROTOCOL}
      - N8N_PATH=/n8n   # Add this line to specify the path
      - WEBHOOK_URL=${PROTOCOL}://${DOMAIN}/n8n/  # Ensure the webhook URL matches the path
      - VIRTUAL_HOST=${DOMAIN}
      - VIRTUAL_PATH=/n8n                       # This line is crucial!
      - LETSENCRYPT_HOST=${DOMAIN}
      - LETSENCRYPT_EMAIL=${EMAIL} 
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true  # Ensure file permissions are enforced

    labels:
      - "com.github.nginx-proxy.nginx-proxy=true"  # This allows Nginx to route to n8n
      - "com.github.nginx-proxy.virtual_host=${DOMAIN}"  # The domain where it will be accessible
      - "com.github.nginx-proxy.virtual_path=/n8n"  # Route traffic to /n8n path
      - "com.github.nginx-proxy.letsencrypt_host=${DOMAIN}"  # Enable Let's Encrypt for this service

    ports:
      - "5678:5678"  # Expose the container port for internal communication 

#     - N8N_BASIC_AUTH_ACTIVE=true
#      - N8N_BASIC_AUTH_USER=admin
#      - N8N_BASIC_AUTH_PASSWORD=
#      - N8N_HOST=proxpire.com
#      - N8N_PORT=5678
#      - WEBHOOK_URL=https://proxpire.com/
#      - N8N_PROTOCOL=${PROTOCOL}
#      - VIRTUAL_HOST=proxpire.com
#      - LETSENCRYPT_HOST=proxpire.com
#      - LETSENCRYPT_EMAIL=

    networks:
      - internal
      - default

    volumes:
      - ./data/n8n/.n8n:/home/node/.n8n
#      - n8n_data:/home/node/.n8n
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 5


  # ------------------------------
  # üß† Ollama (local LLM backend)
  # ------------------------------
  ollama:
    image: ollama/ollama:latest
    # container_name: ollama
    restart: unless-stopped
    volumes:
      - ./data/ollama:/root/.ollama
    ports:
      - "11434:11434" 
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
    networks:
      - internal

  # # Use this deploy section above if you have GPU support
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: all
  #             capabilities: [gpu]


  # ------------------------------
  # üìÇ Qdrant (vector store)
  # ------------------------------
  qdrant:
    image: qdrant/qdrant
    # container_name: qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # Qdrant's default port. For external testing or internal LlamaIndex
      - "6334:6334"
    environment:
      - QDRANT_SERVICE_HTTP_PORT=6333 # HTTP port for external access
      - QDRANT_SERVICE_GRPC_PORT=6334 # gRPC port for internal communication
      - QDRANT_LOG_LEVEL=INFO
    #http://localhost:6333/collections/legal_documents/points/search

    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      - internal

  # ------------------------------
  # üß∞ Redis (optional - caching)
  # ------------------------------
  redis:
    image: redis:7
    # container_name: redis
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
    networks:
      - internal


#  # PostgreSQL (Optional - for N8N database instead of SQLite)
#   postgres:
#     image: postgres:15-alpine
#     container_name: postgres
#     restart: unless-stopped
#     ports:
#       - "5432:5432"
#     environment:
#       - POSTGRES_DB=n8n
#       - POSTGRES_USER=n8n
#       - POSTGRES_PASSWORD=your_db_password_here
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     networks:
#       - legal_ai_network

networks:
  internal:
    driver: bridge
  default: {}  # This will automatically connect services to the default network

#volumes:
#  n8n_data:

